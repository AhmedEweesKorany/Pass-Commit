import{c as L,d as m,e as k,f as U,h as w,i as S}from"../../assets/crypto-CwB3PTAW.js";const a={AUTH_STATE:"authState",VAULT:"vault",SALT:"masterSalt",SESSION_KEY:"sessionKey",SETTINGS:"settings"};let n=null,c=null;async function _(e){const r=L();c=r,n=await m(e,r),await chrome.storage.local.set({[a.SALT]:k(r)})}async function P(e){try{const t=(await chrome.storage.local.get(a.SALT))[a.SALT];return t?(c=U(t),n=await m(e,c),await u()!==null):!1}catch{return n=null,c=null,!1}}function A(){n=null}function v(){return n!==null}function h(){return n}function O(){return c}async function g(e){await chrome.storage.local.set({[a.AUTH_STATE]:e})}async function y(){return(await chrome.storage.local.get(a.AUTH_STATE))[a.AUTH_STATE]||null}async function C(){await chrome.storage.local.remove(a.AUTH_STATE)}async function p(e){if(!n||!c)throw new Error("Vault is locked");const r=await S(JSON.stringify(e),n,c);await chrome.storage.local.set({[a.VAULT]:r})}async function u(){if(!n)return null;const r=(await chrome.storage.local.get(a.VAULT))[a.VAULT];if(!r)return[];try{const t=await w(r,n);return JSON.parse(t)}catch{return null}}async function D(e){const r=await u()||[],t={...e,id:crypto.randomUUID(),createdAt:Date.now(),updatedAt:Date.now()};return r.push(t),await p(r),t}async function I(e){const r=await u();if(!r)return!1;const t=r.findIndex(s=>s.id===e);return t===-1?!1:(r.splice(t,1),await p(r),!0)}async function E(){return!!(await chrome.storage.local.get(a.SALT))[a.SALT]}const V="http://localhost:3001/api";chrome.runtime.onMessage.addListener((e,r,t)=>(M(e).then(t).catch(s=>{console.error("Message handler error:",s),t({success:!1,error:s.message})}),!0));async function M(e){switch(e.type){case"GET_AUTH_STATE":return N();case"LOGIN":return G();case"LOGOUT":return R();case"SET_MASTER_PASSWORD":return K(e.payload);case"UNLOCK_VAULT":return B(e.payload);case"GET_CREDENTIALS":return H();case"SAVE_CREDENTIAL":return J(e.payload);case"DELETE_CREDENTIAL":return b(e.payload);case"AUTOFILL":return F(e.payload);case"GET_DECRYPTED_PASSWORD":return z(e.payload);default:return{success:!1,error:"Unknown message type"}}}async function N(){const e=await y(),r=v(),t=await E();let s=[];return r&&(s=await u()||[]),{success:!0,data:{authState:e?{...e,hasMasterPassword:t}:null,isUnlocked:r,credentials:s}}}async function G(){try{const e=await new Promise((o,d)=>{chrome.identity.getAuthToken({interactive:!0},T=>{chrome.runtime.lastError?d(new Error(chrome.runtime.lastError.message)):T?o(T):d(new Error("No token received"))})}),r=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${e}`}});if(!r.ok)throw new Error("Failed to get user info");const t=await r.json(),s={id:t.id,email:t.email,name:t.name,picture:t.picture};try{await fetch(`${V}/auth/google`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})})}catch{console.warn("Backend not available, using local-only mode")}const i=await E(),l={isAuthenticated:!0,user:s,token:e,hasMasterPassword:i};return await g(l),{success:!0,data:l}}catch(e){return console.error("Login error:",e),{success:!1,error:e.message}}}async function R(){try{const e=await y();return e!=null&&e.token&&await new Promise(r=>{chrome.identity.removeCachedAuthToken({token:e.token},r)}),A(),await C(),{success:!0}}catch(e){return console.error("Logout error:",e),{success:!1,error:e.message}}}async function K(e){try{await _(e.masterPassword);const r=await y();return r&&await g({...r,hasMasterPassword:!0}),{success:!0}}catch(r){return console.error("Set master password error:",r),{success:!1,error:r.message}}}async function B(e){try{return await P(e.masterPassword)?{success:!0}:{success:!1,error:"Invalid master password"}}catch(r){return console.error("Unlock vault error:",r),{success:!1,error:r.message}}}async function H(){try{return{success:!0,data:await u()}}catch(e){return console.error("Get credentials error:",e),{success:!1,error:e.message}}}async function J(e){try{const r=h(),t=O();if(!r||!t)return{success:!1,error:"Vault is locked"};const s=await S(e.encryptedPassword||"",r,t);return{success:!0,data:await D({domain:e.domain||"",username:e.username||"",encryptedPassword:JSON.stringify(s),notes:e.notes})}}catch(r){return console.error("Save credential error:",r),{success:!1,error:r.message}}}async function b(e){try{return{success:await I(e.id)}}catch(r){return console.error("Delete credential error:",r),{success:!1,error:r.message}}}async function F(e){try{const r=await u(),t=r==null?void 0:r.find(d=>d.id===e.credentialId);if(!t)return{success:!1,error:"Credential not found"};const s=h();if(!s)return{success:!1,error:"Vault is locked"};const i=JSON.parse(t.encryptedPassword),l=await w(i,s),[o]=await chrome.tabs.query({active:!0,currentWindow:!0});return o!=null&&o.id&&await chrome.tabs.sendMessage(o.id,{type:"DO_AUTOFILL",payload:{username:t.username,password:l}}),{success:!0}}catch(r){return console.error("Auto-fill error:",r),{success:!1,error:r.message}}}async function z(e){try{const r=await u(),t=r==null?void 0:r.find(o=>o.id===e.credentialId);if(!t)return{success:!1,error:"Credential not found"};const s=h();if(!s)return{success:!1,error:"Vault is locked"};const i=JSON.parse(t.encryptedPassword);return{success:!0,data:await w(i,s)}}catch(r){return console.error("Get decrypted password error:",r),{success:!1,error:r.message}}}let f=null;const W=5*60*1e3;function Y(){f&&clearTimeout(f),f=setTimeout(()=>{A()},W)}chrome.runtime.onMessage.addListener(()=>{Y()});console.log("PassCommit background service worker initialized");
